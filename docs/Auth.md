# Authentication

This document contains information related to the BOSS Authentication configuration
and samples of how to authenticate to the BOSS API.

## OpenID Connect
[OpenID Connect (OIDC)](http://openid.net/connect/) is a protocol on top of OAuth
2.0 that handles identification.

The way that we make use of the protocol is that there is an Authentication Server
that is the authoritative source for user accounts and user information. When a
user goes to login to an application they are redirected to the Auth Server where
they enter their username and password to identify themselves to the Auth Server.
The Auth Server then generates (???) and redirects the user back to the application.

In some cases the application will call another application using the access token
that was generated by Keycloak and given to the original application.

If a user tries to login to another application and their original Keycloak session
has not expired, the Keycloak login page is not displayed and the user is immediantly
redirected back to the application.

## Keycloak
Keycloak is the Authentication Server that is being used in the BOSS architecture.
It is an OIDC Provider and allows the different applications to authenticate to it.

Keycloak provides a REST API that allows the BOSS admin page to make changes to
Keycloak on behalf of authorized users. Actions can include creating/maintaining/
deleting users, groups, and roles.

Keycloak can also allow thirdparty authentication services (like Github.com) that
use OIDC to be the authentication source for a user, eliminating the need for a
user to make a BOSS specific account.

## Django
Currently there are only Django applications that are authenticating to Keycloak.
There are three different plugins that are used to handle difference authentication
scenarios.

### django-oidc
The [django-oidc](https://github.com/jhuapl-boss/django-oidc.git) plugin is a BOSS
fork of a Django plugin that provides session based OIDC authentication. This means
that is only handles when a user logs into the Django web site and a session is
created for them.

The BOSS fork of the plugin has a couple of fixes to allow the plugin to run under
Python 3.

### drf-oidc-auth
The [drf-oidc-auth](https://github.com/ByteInternet/drf-oidc-auth) plugin provides
token based OIDC authentication. This is needed when an application, that already
authenticated the user with Keycloak and has an access token, tries to call another
application using an access token.

### boss-oidc
The [boss-oidc](https://github.com/jhuapl-boss/boss-oidc.git) plugin is a custom
plugin that provides a single configuration function for both the django-oidc and
drf-oidc-auth plugins. It also provides a some custom authentication hooks by
extending the existing plugins.

### Patches
In addition to the different Django auth plugins, there are a couple of patches
to Django and Django Rest Framework that are applied when AMIs are built. These
patches help integrate that auth plugins better within Django. The patches do
things like override the Django Rest Framework login page to use the django-oidc
Keycloak page and place a link of the Django admin login page to the django-oidc
Keycloak page.

## Token Authentication

There are two types of token authentication. The first uses tokens from Keycloak
and will expire when the Keycloak session expires. The boss-oidc Django plugin
(using the drf-oidc-auth plugin) is responsible for verifying the token.

The second is specific to the BOSS API. It uses local Django Rest Framework tokens
that do not expire. To get an API token a user must log into the BOSS API admin
pannel and generate a token. From the admin pennal the user can also revoke their
token. Currently the token admin page resides at https://api.theboss.io/token/

The reason for the implementing the Django Rest Framework tokens is because we
want to support non-expiring API tokens. Keycloak backed tokens will eventually
expire, even if the token lasts for several months. We didn't want an API token
to expire in the middle of someone processing a large batch of data.

### Example Code
Some sample code on how to call the BOSS API using token authentication.

```python
#!/usr/bin/env python3

import ssl
from urllib.request import Request, urlopen
from urllib.parse import urlencode
from urllib.error import HTTPError

def request(url, params = None, headers = {}, method = None, convert = urlencode):
    rq = Request(
        url,
        data = None if params is None else convert(params).encode("utf-8"),
        headers = headers,
        method = method
    )

    if url.startswith("https"):
        ctx = ssl.create_default_context()
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
    else:
        ctx = None

    try:
        response = urlopen(rq, context=ctx).read().decode("utf-8")
        return response
    except HTTPError as e:
        print(e)
        return e.read().decode("utf-8")

token = "xxxxxxxxxxxxxxxxxxxxxxxxxxxx" # replace with token obtained from https://api.theboss.io/token/
response = request("https://api.theboss.io/v0.3/info/collections",
                    headers={
                        "Authorization": "Token " + token,
                        "Content-Type": "application/x-www-form-urlencoded",
                    }
                   )

print(response)
```
