@startuml

header Last updated 21Sep2021
footer Generated from Index.FindCuboids.uml by PlantUML
title Index.FindCuboids Step Function Diagram

[*] --> Init
Init: Add inputs as status
Init --> WhileStillTraversingLookupKeyIndex

WhileStillTraversingLookupKeyIndex --> [*]: Done
WhileStillTraversingLookupKeyIndex --> UpdateOperationFieldQuery

UpdateOperationFieldQuery: set operation = QueryS3Index
UpdateOperationFieldQuery --> QueryS3IndexTable

QueryS3IndexTable: index_find_cuboids_lambda.py
QueryS3IndexTable --> S3ReadFailed: failure reading from DynamoDB
QueryS3IndexTable --> IfNumBatchesGreaterThan0

S3ReadFailed --> Fail
S3ReadFailed : send lambda error to index deadletter queue

IfNumBatchesGreaterThan0 --> UpdateOperationFieldSpawnEnqueueSfn : true
IfNumBatchesGreaterThan0 --> WhileStillTraversingLookupKeyIndex : false

UpdateOperationFieldSpawnEnqueueSfn: set operation = Start enqueue cuboids SFN
UpdateOperationFieldSpawnEnqueueSfn --> AsynchEnqueueCuboids

AsynchEnqueueCuboids: start EnqueueCuboids SFN
AsynchEnqueueCuboids: start_sfn_lambda.py
AsynchEnqueueCuboids --> StartEnqueueFailedToDeadletterQueue : error starting EnqueueCuboids SFN
AsynchEnqueueCuboids --> WhileStillTraversingLookupKeyIndex : no error

StartEnqueueFailedToDeadletterQueue --> Fail

@enduml

