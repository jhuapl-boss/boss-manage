name: multilambda
runtime: python3.7
include:
        # DP NOTE: The spdb, bossutils (boss-tools), and heaviside repositories
        #          are copied into repos/ where pip can install them from
        salt_stack/salt/spdb/files/spdb.git: repos/spdb
        salt_stack/salt/boss-tools/files/boss-tools.git: repos/boss-tools
        salt_stack/salt/boss-tools/files/boss-tools.git/cloudwatchwrapper: cloudwatchwrapper
        salt_stack/salt/boss-tools/files/boss-tools.git/lambda: lambda
        salt_stack/salt/boss-tools/files/boss-tools.git/lambdautils: lambdautils
        salt_stack/salt/ndingest/files/ndingest.git: repos/ndingest
        lib/heaviside.git: repos/heaviside
        lib/heaviside.git/requirements.txt: requirements/heaviside/requirements.txt
        lib/names.py: bossnames/names.py
        lib/bucket_object_tags.py: bossnames/bucket_object_tags.py
        lib/__init__.py: bossnames/__init__.py
system_packages:
        # lib dependencies
        - libjpeg-turbo-devel.x86_64
        - zlib-devel.x86_64
        - libtiff-devel.x86_64
        - freetype.x86_64
        - lcms2-devel.x86_64
        - libwebp-devel.x86_64
        - openjpeg-devel.x86_64

        # numpy-blosc dependencies
        - atlas
        - atlas-devel
        - gcc
        - gcc-c++
python_packages:
        - repos/spdb/
        - repos/boss-tools/bossutils/
        - repos/ndingest/
        - repos/heaviside/
manual_commands:
        - |
                # Copy settings file for ndingest
                cp repos/ndingest/ndingest/settings/settings.ini ./ndingest/settings
        - |
                # set the correct log config for bossutils
                echo configuring logging
                cp repos/boss-tools/bossutils/src/bossutils/lambda_logger_conf.json ./bossutils/logger_conf.json
        - |
                # Remove repositories used to do install
                rm -rf repos/
        - | # Should this be a manual command or a list of files to be copied into the staging directory
                # copy the BLAS libraries into relative directories
                cp /usr/lib64/atlas/libatlas.so.3 .
                cp /usr/lib64/atlas/libptf77blas.so.3 .
                cp /usr/lib64/atlas/libf77blas.so.3 .
                cp /usr/lib64/atlas/libptcblas.so.3 .
                cp /usr/lib64/atlas/libcblas.so.3 .
                cp /usr/lib64/atlas/liblapack.so.3 .

                cp /usr/lib64/libgfortran.so.3 .
                cp /usr/lib64/libquadmath.so.0 .
        - |
                # copy the lambda handlers into the root of the package
                cp lambda/* .
