#!/bin/bash

# Copyright 2018 The Johns Hopkins University Applied Physics Laboratory
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

USAGE="USAGE: $0 --copy (--compose|--config) [file_name]"
DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CONFIG_DIR="${DIR}/../config/"

# TODO: check for realpath and only use if installed
CONFIG_DIR="`realpath ${CONFIG_DIR}`"

# TODO: deactivate flag to remove linked configs?

COPY=false
COMPOSE=false
CONFIG=false
while true; do
    case "$1" in
        --copy) COPY=true ; shift ;;
        --compose) COMPOSE=true ; shift ;;
        --config) CONFIG=true ; shift ;;
        -h | --help) echo $USAGE ; exit 0 ;;
        --) shift ; break ;;
        *) break;
    esac
done

if ( $COMPOSE && $CONFIG ) ; then
    echo "Cannot use both --config and --compose"
    echo $USAGE
    exit 1
else
    if ( $CONFIG ) ; then
        TYPE="config"
    else
        TYPE="compose"
    fi
fi

if [ $# -ne 1 ] ; then
    # TODO: handle when both boss_config and boss_compose exist
    TARGET="${CONFIG_DIR}/boss_config.py"
    if [ ! -e $TARGET ] ; then
        TARGET="${CONFIG_DIR}/boss_compose.py"
    fi
    if [ ! -e $TARGET ] ; then
        CURRENT="(none)"
    else
        CURRENT=`grep BOSS_NAME $TARGET | cut -d\" -f2`
    fi

    echo "BOSS Configurations"
    echo
    echo "Current: $CURRENT"
    echo
    echo "Config:"
    for config in `(cd $CONFIG_DIR && ls *_config.py | grep -v boss)` ; do
        config=`echo $config | cut -d_ -f1`
        echo "    $config"
    done
    echo
    echo "Compose:"
    for config in `(cd $CONFIG_DIR && ls *_compose.py | grep -v boss)` ; do
        config=`echo $config | cut -d_ -f1`
        echo "    $config"
    done

    exit 0
fi

FILE="${CONFIG_DIR}/${1}_${TYPE}.py"
if [ ! -e $FILE ] ; then
    FILE="${CONFIG_DIR}/${1}.py"
fi

if [ ! -e $FILE ] ; then
    echo "File \"$FILE\" doesn't exist"
    exit 1
fi

TARGET="${CONFIG_DIR}/boss_${TYPE}.py"
echo "Linking $FILE to $TARGET"
if [ -e $TARGET ] && [ ! -h $TARGET ] && ( ! $COPY ) ; then
    echo "${TARGET} is a regular file, not overridding"
    exit 1
else
    if $COPY ; then
        cp $FILE $TARGET
    else
        ln -s $FILE $TARGET
    fi
fi

